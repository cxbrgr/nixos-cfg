services:

  # Usenet download client
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    environment:
      - PUID=1000
      - PGID=100
      - TZ=Europe/Vienna
    volumes:
      - /data/docker/sabnzbd:/config
      - /data:/data
    ports:
      - 10106:8080
    restart: unless-stopped

  # index manager (usenet & torrents)
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=1000
      - PGID=100
      - TZ=Europe/Vienna
    volumes:
      - /data/docker/prowlarr:/config
    ports:
      - 10101:9696
    restart: unless-stopped

  # movie manager
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=1000
      - PGID=100
      - TZ=Europe/Vienna
    volumes:
      - /data/docker/sonarr:/config
      - /data:/data
    ports:
      - 10102:8989
    restart: unless-stopped

  # --- series manager ---
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=1000
      - PGID=100
      - TZ=Europe/Vienna
    volumes:
      - /data/docker/radarr:/config
      - /data:/data
    ports:
      - 10103:7878
    restart: unless-stopped

  # --- subtitle manager ---
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=1000
      - PGID=100
      - TZ=Europe/Vienna
    volumes:
      - /data/docker/bazarr:/config
      - /data:/data
    ports:
      - 10104:6767
    restart: unless-stopped

  # jelly stack - manage movies & series & co
  overseerr:
    image: sctx/overseerr:latest
    container_name: overseerr
    environment:
      - PUID=1000
      - PGID=100
      - TZ=Europe/Vienna
    volumes:
      - /data/docker/overseerr:/app/config
    ports:
      - 10105:5055
    restart: unless-stopped

  # plex stack - player
  plex: 
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host
    environment:
      - PUID=1000
      - PGID=100
      - TZ=Europe/Vienna
      - VERSION=docker
    volumes:
      - /data/docker/plex:/config
      - /data/media:/data/media
    devices:
      - /dev/dri:/dev/dri # Passes the i5-12400 iGPU for transcoding
    restart: unless-stopped

  # jelly stack - manage movies & series & co
  jellyseerr:
    image: ghcr.io/fallenbagel/jellyseerr:latest
    init: true
    container_name: jellyseerr
    environment:
      - LOG_LEVEL=debug
      - TZ=Europe/Vienna
      - PORT=5055
    ports:
      - 10107:5055
    volumes:
      - /data/docker/jellyseerr:/app/config
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 3
    restart: unless-stopped    

  # jelly stack - player
  jellyfin:
    image: jellyfin/jellyfin
    container_name: jellyfin
    user: 1000:100
    ports:
      - 10108:8096/tcp
      - 10109:7359/udp
    volumes:
      - /data/docker/jellyfin/config:/config
      - /data/docker/jellyfin/cache:/cache
      - type: bind
        source: /data/media
        target: /media
      - type: bind
        source: /run/current-system/sw/share/X11/fonts
        target: /usr/local/share/fonts/custom
        read_only: true
    restart: 'unless-stopped'
    devices:
      - /dev/dri:/dev/dri  # Intel i5-12400 iGPU for hardware transcoding
    environment:
      - JELLYFIN_PublishedServerUrl=http://jellyfin.hmsrvr.lan
    extra_hosts:
      - 'host.docker.internal:host-gateway'

  # gateway with SSL
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./landing:/var/www/landing:ro
      - /data/docker/certs:/etc/letsencrypt:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "hmsrvr:host-gateway"
    depends_on:
      - prowlarr
      - sonarr
      - radarr
      - bazarr
      - overseerr
      - sabnzbd
      - plex
      - jellyfin
      - jellyseerr
    restart: unless-stopped

  # SSL certificate management
  certbot:
    image: certbot/dns-cloudflare
    container_name: certbot
    volumes:
      - /data/docker/certs:/etc/letsencrypt
      - ../../.keys/cloudflare.ini:/etc/cloudflare/credentials.ini:ro
    environment:
      - TZ=Europe/Vienna
    # Run once to get initial cert, then renewal via cron/systemd
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped
